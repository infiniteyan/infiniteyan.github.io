{"title":"GO实现WebSocket消息推送","date":"2019-04-21T07:59:07.000Z","slug":"GO实现WebSocket消息推送","comments":true,"updated":"2019-04-21T08:07:12.608Z","content":"<h4 id=\"客户端\">客户端<a href=\"post/GO实现WebSocket消息推送#客户端\"></a></h4><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"</span></span><br><span class=\"line\"><span class=\"meta\">        \"http://www.w3.org/TR/html4/loose.dtd\"&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>WebSocket Client<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"utf-8\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">        window.addEventListener(\"load\", function(evt) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">            var output = document.getElementById(\"output\");</span></span><br><span class=\"line\"><span class=\"undefined\">            var input = document.getElementById(\"input\");</span></span><br><span class=\"line\"><span class=\"undefined\">            var ws;</span></span><br><span class=\"line\"><span class=\"undefined\">            var print = function(message) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                var d = document.createElement(\"div\");</span></span><br><span class=\"line\"><span class=\"undefined\">                d.innerHTML = message;</span></span><br><span class=\"line\"><span class=\"undefined\">                output.appendChild(d);</span></span><br><span class=\"line\"><span class=\"undefined\">            &#125;;</span></span><br><span class=\"line\"><span class=\"undefined\">            document.getElementById(\"open\").onclick = function(evt) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                if (ws) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                    return false;</span></span><br><span class=\"line\"><span class=\"undefined\">                &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">                ws = new WebSocket(\"ws://localhost:5555/ws\");</span></span><br><span class=\"line\"><span class=\"undefined\">                ws.onopen = function(evt) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                    print(\"OPEN\");</span></span><br><span class=\"line\"><span class=\"undefined\">                &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">                ws.onclose = function(evt) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                    print(\"CLOSE\");</span></span><br><span class=\"line\"><span class=\"undefined\">                    ws = null;</span></span><br><span class=\"line\"><span class=\"undefined\">                &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">                ws.onmessage = function(evt) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                    print(\"RESPONSE: \" + evt.data);</span></span><br><span class=\"line\"><span class=\"undefined\">                &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">                ws.onerror = function(evt) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                    print(\"ERROR: \" + evt.data);</span></span><br><span class=\"line\"><span class=\"undefined\">                &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">                return false;</span></span><br><span class=\"line\"><span class=\"undefined\">            &#125;;</span></span><br><span class=\"line\"><span class=\"undefined\">            document.getElementById(\"send\").onclick = function(evt) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                if (!ws) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                    return false;</span></span><br><span class=\"line\"><span class=\"undefined\">                &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">                print(\"Client send: \" + input.value);</span></span><br><span class=\"line\"><span class=\"undefined\">                ws.send(input.value);</span></span><br><span class=\"line\"><span class=\"undefined\">                return false;</span></span><br><span class=\"line\"><span class=\"undefined\">            &#125;;</span></span><br><span class=\"line\"><span class=\"undefined\">            document.getElementById(\"close\").onclick = function(evt) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                if (!ws) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                    return false;</span></span><br><span class=\"line\"><span class=\"undefined\">                &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">                ws.close();</span></span><br><span class=\"line\"><span class=\"undefined\">                return false;</span></span><br><span class=\"line\"><span class=\"undefined\">            &#125;;</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;);</span></span><br><span class=\"line\"><span class=\"undefined\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">valign</span>=<span class=\"string\">\"top\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"50%\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>Click \"Open\" to create a connection to the server,</span><br><span class=\"line\">                \"Send\" to send a message to the server and \"Close\" to close the connection.</span><br><span class=\"line\">                You can change the message and send multiple times.</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">id</span>=<span class=\"string\">\"open\"</span>&gt;</span>Open<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">id</span>=<span class=\"string\">\"close\"</span>&gt;</span>Close<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">\"input\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"Hello world!\"</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">id</span>=<span class=\"string\">\"send\"</span>&gt;</span>Send<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">td</span> <span class=\"attr\">valign</span>=<span class=\"string\">\"top\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"50%\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"output\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"服务端\">服务端<a href=\"post/GO实现WebSocket消息推送#服务端\"></a></h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"net/http\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/gorilla/websocket\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"go-websocket/impl\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">var upgrader = websocket.Upgrader&#123;</span><br><span class=\"line\">\tCheckOrigin: func(r *http.Request) <span class=\"keyword\">bool</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">\t&#125;,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func handleWS(writer http.ResponseWriter, req *http.Request) &#123;</span><br><span class=\"line\">\tvar (</span><br><span class=\"line\">\t\tconn *websocket.Conn</span><br><span class=\"line\">\t\terr error</span><br><span class=\"line\">\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\tconn, err = upgrader.Upgrade(writer, req, nil)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\twriter.Write([]byte(<span class=\"string\">\"failed to upgrade to websocket.\"</span>))</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\twsConn := impl.WsConnection&#123;</span><br><span class=\"line\">\t\tConn: conn,</span><br><span class=\"line\">\t\tInMsgQueue: make(chan *impl.WsMessage, <span class=\"number\">10000</span>),</span><br><span class=\"line\">\t\tOutMsgQueue: make(chan *impl.WsMessage, <span class=\"number\">10000</span>),</span><br><span class=\"line\">\t\tCloseChannel: make(chan <span class=\"keyword\">int</span>),</span><br><span class=\"line\">\t\tIsClosed: <span class=\"literal\">false</span>,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tgo wsConn.HandleRecvMsg()</span><br><span class=\"line\">\tgo wsConn.HandleSendMsg()</span><br><span class=\"line\">\tgo wsConn.ProcessLoop()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tmux := http.NewServeMux()</span><br><span class=\"line\">\tmux.HandleFunc(<span class=\"string\">\"/ws\"</span>, handleWS)</span><br><span class=\"line\"></span><br><span class=\"line\">\thttp.ListenAndServe(<span class=\"string\">\"0.0.0.0:5555\"</span>, mux)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package impl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"errors\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/gorilla/websocket\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"sync\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type WsMessage <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">\tmsgType\t\t<span class=\"keyword\">int</span></span><br><span class=\"line\">\tbuffer \t\t[]byte</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type WsConnection <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">\tConn \t\t\t*websocket.Conn</span><br><span class=\"line\">\tInMsgQueue \t\tchan *WsMessage</span><br><span class=\"line\">\tOutMsgQueue \tchan *WsMessage</span><br><span class=\"line\">\tCloseChannel \tchan <span class=\"keyword\">int</span></span><br><span class=\"line\">\tIsClosed \t\t<span class=\"keyword\">bool</span></span><br><span class=\"line\">\tlock\t\t\tsync.Mutex</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (wsConn *WsConnection) HandleRecvMsg() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\tmType, data, err := wsConn.Conn.ReadMessage()</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\t\twsConn.close()</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> wsConn.InMsgQueue &lt;- &amp;WsMessage&#123;msgType:mType, buffer:data&#125;:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> &lt;- wsConn.CloseChannel:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (wsConn *WsConnection) HandleSendMsg() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> msgBody := &lt;- wsConn.OutMsgQueue :</span><br><span class=\"line\">\t\t\terr := wsConn.Conn.WriteMessage(msgBody.msgType, msgBody.buffer)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\t\t\twsConn.close()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> &lt;- wsConn.CloseChannel:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (wsConn *WsConnection) ProcessLoop() &#123;</span><br><span class=\"line\">\tgo func() &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t\terr := wsConn.sendMsg(websocket.TextMessage, (<span class=\"string\">\"heartbeat from server...\"</span>))</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\t\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t\t\twsConn.close()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\ttime.Sleep(time.Second * <span class=\"number\">5</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\twsMsg, err := wsConn.recvMsg()</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(<span class=\"string\">\"failed to read.\"</span>, err)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">\"recv from client:\"</span>, <span class=\"built_in\">string</span>(wsMsg.buffer))</span><br><span class=\"line\">\t\terr = wsConn.sendMsg(websocket.TextMessage, <span class=\"string\">\"SERVER ECHO:\"</span> + <span class=\"built_in\">string</span>(wsMsg.buffer))</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(<span class=\"string\">\"failed to send.\"</span>, err)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (wsConn *WsConnection) sendMsg(msgType <span class=\"keyword\">int</span>, msgContent <span class=\"built_in\">string</span>) error &#123;</span><br><span class=\"line\">\tmsg := &amp;WsMessage&#123;msgType:msgType, buffer:[]byte(msgContent)&#125;</span><br><span class=\"line\">\tselect &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> wsConn.OutMsgQueue &lt;- msg:</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> nil</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> &lt;- wsConn.CloseChannel:</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> errors.New(<span class=\"string\">\"connection has closed.\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (wsConn *WsConnection) recvMsg() (*WsMessage, error) &#123;</span><br><span class=\"line\">\tselect &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> newMsg := &lt;- wsConn.InMsgQueue:</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> newMsg, nil</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> &lt;- wsConn.CloseChannel:</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> nil, errors.New(<span class=\"string\">\"connection has closed.\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (wsConn *WsConnection) close() &#123;</span><br><span class=\"line\">\twsConn.lock.Lock()</span><br><span class=\"line\">\tdefer wsConn.lock.Unlock()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !wsConn.IsClosed &#123;</span><br><span class=\"line\">\t\twsConn.Conn.Close()</span><br><span class=\"line\">\t\twsConn.IsClosed = <span class=\"literal\">true</span></span><br><span class=\"line\">\t\tclose(wsConn.CloseChannel)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","next":{"title":"WebSocket协议详解","slug":"WebSocket协议详解"},"link":"http://yoursite.com/post/GO实现WebSocket消息推送/"}