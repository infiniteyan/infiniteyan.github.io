{"title":"NDK编译ffmpeg","date":"2020-05-02T14:45:47.000Z","slug":"NDK编译ffmpeg","comments":true,"updated":"2020-05-02T14:53:41.698Z","content":"<h4 id=\"一、准备环境\">一、准备环境<a href=\"post/NDK编译ffmpeg#一、准备环境\"></a></h4><p>操作系统：Mac<br>NDK版本：r17c<br>FFmpeg版本：4.1.5</p>\n<h4 id=\"二、编译脚本\">二、编译脚本<a href=\"post/NDK编译ffmpeg#二、编译脚本\"></a></h4><p>首先我们需要修改下FFmpeg目录下的configure文件的内容，<br>将<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SLIBNAME_WITH_MAJOR=&apos;$(SLIBNAME).$(LIBMAJOR)&apos;</span><br><span class=\"line\">LIB_INSTALL_EXTRA_CMD=&apos;$$(RANLIB) &quot;$(LIBDIR)/$(LIBNAME)&quot;&apos;</span><br><span class=\"line\">SLIB_INSTALL_NAME=&apos;$(SLIBNAME_WITH_VERSION)&apos;</span><br><span class=\"line\">SLIB_INSTALL_LINKS=&apos;$(SLIBNAME_WITH_MAJOR) $(SLIBNAME)&apos;</span><br></pre></td></tr></table></figure></p>\n<p>替换成<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SLIBNAME_WITH_MAJOR=&apos;$(SLIBPREF)$(FULLNAME)-$(LIBMAJOR)$(SLIBSUF)&apos;</span><br><span class=\"line\">LIB_INSTALL_EXTRA_CMD=&apos;$$(RANLIB) &quot;$(LIBDIR)/$(LIBNAME)&quot;&apos;</span><br><span class=\"line\">SLIB_INSTALL_NAME=&apos;$(SLIBNAME_WITH_MAJOR)&apos;</span><br><span class=\"line\">SLIB_INSTALL_LINKS=&apos;$(SLIBNAME)&apos;</span><br></pre></td></tr></table></figure></p>\n<p>然后在FFmpeg目录下新建一个build.sh文件，这个将作为编译脚本使用。<br>编译脚本内容是：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">NDK=/Users/yanshiwei/Library/Android/android-ndk-r17</span><br><span class=\"line\"></span><br><span class=\"line\">ARM_PLATFORM=$NDK/platforms/android-21/arch-arm/</span><br><span class=\"line\">ARM_PREBUILT=$NDK/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64</span><br><span class=\"line\"></span><br><span class=\"line\">ARM64_PLATFORM=$NDK/platforms/android-21/arch-arm64/</span><br><span class=\"line\">ARM64_PREBUILT=$NDK/toolchains/aarch64-linux-android-4.9/prebuilt/darwin-x86_64</span><br><span class=\"line\"></span><br><span class=\"line\">X86_PLATFORM=$NDK/platforms/android-21/arch-x86/</span><br><span class=\"line\">X86_PREBUILT=$NDK/toolchains/x86-4.9/prebuilt/darwin-x86_64</span><br><span class=\"line\"></span><br><span class=\"line\">X86_64_PLATFORM=$NDK/platforms/android-21/arch-x86_64/</span><br><span class=\"line\">X86_64_PREBUILT=$NDK/toolchains/x86_64-4.9/prebuilt/darwin-x86_64</span><br><span class=\"line\"></span><br><span class=\"line\">ISYSROOT=$NDK/sysroot</span><br><span class=\"line\">ASM=$ISYSROOT/usr/include/arm-linux-androideabi</span><br><span class=\"line\"></span><br><span class=\"line\">BUILD_DIR=`pwd`/ffmpeg-android</span><br><span class=\"line\"></span><br><span class=\"line\">function build_one</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">if [ $ARCH == &quot;arm&quot; ]</span><br><span class=\"line\">then</span><br><span class=\"line\">    PLATFORM=$ARM_PLATFORM</span><br><span class=\"line\">    PREBUILT=$ARM_PREBUILT</span><br><span class=\"line\">    HOST=arm-linux-androideabi</span><br><span class=\"line\">elif [ $ARCH == &quot;arm64&quot; ]</span><br><span class=\"line\">then</span><br><span class=\"line\">    PLATFORM=$ARM64_PLATFORM</span><br><span class=\"line\">    PREBUILT=$ARM64_PREBUILT</span><br><span class=\"line\">    HOST=aarch64-linux-android</span><br><span class=\"line\">elif [ $ARCH == &quot;x86_64&quot; ]</span><br><span class=\"line\">then</span><br><span class=\"line\">    PLATFORM=$X86_64_PLATFORM</span><br><span class=\"line\">    PREBUILT=$X86_64_PREBUILT</span><br><span class=\"line\">    HOST=x86_64-linux-android</span><br><span class=\"line\">else</span><br><span class=\"line\">    PLATFORM=$X86_PLATFORM</span><br><span class=\"line\">    PREBUILT=$X86_PREBUILT</span><br><span class=\"line\">    HOST=i686-linux-android</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">./configure --target-os=linux \\</span><br><span class=\"line\">    --prefix=$PREFIX \\</span><br><span class=\"line\">    --incdir=$BUILD_DIR/include \\</span><br><span class=\"line\">    --libdir=$BUILD_DIR/lib/$CPU \\</span><br><span class=\"line\">    --enable-cross-compile \\</span><br><span class=\"line\">    --arch=$ARCH \\</span><br><span class=\"line\">    --cc=$PREBUILT/bin/$HOST-gcc \\</span><br><span class=\"line\">    --cross-prefix=$PREBUILT/bin/$HOST- \\</span><br><span class=\"line\">    --nm=$PREBUILT/bin/$HOST-nm \\</span><br><span class=\"line\">    --sysroot=$PLATFORM \\</span><br><span class=\"line\">    --extra-cflags=&quot;-I$ASM -isysroot $ISYSROOT -I$BUILD_DIR/include -fPIC -DANDROID -Wfatal-errors -Wno-deprecated $OPTIMIZE_CFLAGS&quot; \\</span><br><span class=\"line\">    --enable-gpl \\</span><br><span class=\"line\">    --enable-small \\</span><br><span class=\"line\">    --extra-ldflags=&quot;-L$BUILD_DIR/lib/$CPU&quot; \\</span><br><span class=\"line\">    --enable-shared \\</span><br><span class=\"line\">    --disable-doc \\</span><br><span class=\"line\">    --disable-programs \\</span><br><span class=\"line\">    --disable-stripping \\</span><br><span class=\"line\">    --disable-symver \\</span><br><span class=\"line\">    --disable-static \\</span><br><span class=\"line\">    --pkg-config=/usr/bin/pkg-config \\</span><br><span class=\"line\">    $ADDITIONAL_CONFIGURE_FLAG</span><br><span class=\"line\"></span><br><span class=\"line\">make clean</span><br><span class=\"line\">make -j8</span><br><span class=\"line\">make install</span><br><span class=\"line\">popd</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#arm v7vfpv3</span><br><span class=\"line\">#CPU=armv7-a</span><br><span class=\"line\">#ARCH=arm</span><br><span class=\"line\">#OPTIMIZE_CFLAGS=&quot;-mfloat-abi=softfp -mfpu=vfpv3-d16 -marm -march=$CPU -D__thumb__ -mthumb&quot;</span><br><span class=\"line\">#PREFIX=$BUILD_DIR/$CPU</span><br><span class=\"line\">#ADDITIONAL_CONFIGURE_FLAG=</span><br><span class=\"line\">#build_one</span><br><span class=\"line\"></span><br><span class=\"line\">#arm v7vfp</span><br><span class=\"line\">#CPU=armv7-a</span><br><span class=\"line\">#ARCH=arm</span><br><span class=\"line\">#OPTIMIZE_CFLAGS=&quot;-mfloat-abi=softfp -mfpu=vfp -marm -march=$CPU &quot;</span><br><span class=\"line\">#PREFIX=`pwd`/ffmpeg-android/$CPU-vfp</span><br><span class=\"line\">#ADDITIONAL_CONFIGURE_FLAG=</span><br><span class=\"line\">#build_one</span><br><span class=\"line\"></span><br><span class=\"line\">#arm v7n</span><br><span class=\"line\">CPU=armv7-a</span><br><span class=\"line\">ARCH=arm</span><br><span class=\"line\">OPTIMIZE_CFLAGS=&quot;-mfloat-abi=softfp -mfpu=neon -marm -march=$CPU -mtune=cortex-a8&quot;</span><br><span class=\"line\">PREFIX=$BUILD_DIR/$CPU</span><br><span class=\"line\">ADDITIONAL_CONFIGURE_FLAG=</span><br><span class=\"line\">build_one</span><br><span class=\"line\"></span><br><span class=\"line\">#arm64-v8a</span><br><span class=\"line\"># CPU=arm64-v8a</span><br><span class=\"line\"># ARCH=arm64</span><br><span class=\"line\"># OPTIMIZE_CFLAGS=</span><br><span class=\"line\"># PREFIX=$BUILD_DIR/$CPU</span><br><span class=\"line\"># ADDITIONAL_CONFIGURE_FLAG=</span><br><span class=\"line\"># build_one</span><br><span class=\"line\"></span><br><span class=\"line\">#x86_64</span><br><span class=\"line\"># CPU=x86_64</span><br><span class=\"line\"># ARCH=x86_64</span><br><span class=\"line\"># OPTIMIZE_CFLAGS=&quot;-fomit-frame-pointer&quot;</span><br><span class=\"line\"># PREFIX=$BUILD_DIR/$CPU</span><br><span class=\"line\"># ADDITIONAL_CONFIGURE_FLAG=</span><br><span class=\"line\"># build_one</span><br><span class=\"line\"></span><br><span class=\"line\">#x86</span><br><span class=\"line\">CPU=i686</span><br><span class=\"line\">ARCH=i686</span><br><span class=\"line\">OPTIMIZE_CFLAGS=&quot;-fomit-frame-pointer&quot;</span><br><span class=\"line\">PREFIX=$BUILD_DIR/$CPU</span><br><span class=\"line\">ADDITIONAL_CONFIGURE_FLAG=</span><br><span class=\"line\">build_one</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"三、操作步骤\">三、操作步骤<a href=\"post/NDK编译ffmpeg#三、操作步骤\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sh ./build.sh</span><br></pre></td></tr></table></figure>\n<h4 id=\"四、过程踩坑\">四、过程踩坑<a href=\"post/NDK编译ffmpeg#四、过程踩坑\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">stdint.h:9:26: fatal error: stdint.h: No such file or directory</span><br></pre></td></tr></table></figure>\n<p>原因和解决办法：<br>头文件找不到，是因为r17c这个版本把头文件分离出来了，需在–extra-cflags中添加 “-isysroot  $NDK/sysroot”</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2.</span><br><span class=\"line\">libavcodec/aaccoder.c: In function &apos;search_for_ms&apos;:</span><br><span class=\"line\">libavcodec/aaccoder.c:803:25: error: expected identifier or &apos;(&apos; before numeric constant</span><br><span class=\"line\">                     int B0 = 0, B1 = 0;</span><br></pre></td></tr></table></figure>\n<p>原因和解决办法：变量名冲突了，修改FFmpeg/libavcodec/aaccoder.c 文件B0改成b0或者其他不会冲突的变量名</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">3.</span><br><span class=\"line\">libavcodec/hevc_mvs.c: In function &apos;derive_spatial_merge_candidates&apos;:</span><br><span class=\"line\">libavcodec/hevc_mvs.c:208:15: error: &apos;y0000000&apos; undeclared (first use in this function)</span><br><span class=\"line\">             ((y ## v) &gt;&gt; s-&gt;ps.sps-&gt;log2_min_pu_size))</span><br><span class=\"line\">               ^</span><br><span class=\"line\">libavcodec/hevc_mvs.c:204:14: note: in definition of macro &apos;TAB_MVF&apos;</span><br><span class=\"line\">     tab_mvf[(y) * min_pu_width + x]</span><br><span class=\"line\">              ^</span><br><span class=\"line\">libavcodec/hevc_mvs.c:274:16: note: in expansion of macro &apos;TAB_MVF_PU&apos;</span><br><span class=\"line\">     (cand &amp;&amp; !(TAB_MVF_PU(v).pred_flag == PF_INTRA))</span><br><span class=\"line\">                ^</span><br><span class=\"line\">libavcodec/hevc_mvs.c:368:23: note: in expansion of macro &apos;AVAILABLE&apos;</span><br><span class=\"line\">     is_available_b0 = AVAILABLE(cand_up_right, B0) &amp;&amp;</span><br><span class=\"line\">                       ^</span><br><span class=\"line\">compilation terminated due to -Wfatal-errors.</span><br><span class=\"line\">make: *** [libavcodec/hevc_mvs.o] Error 1</span><br></pre></td></tr></table></figure>\n<p>原因和解决方法：变量名冲突了，将FFmpeg/libavcodec/hevc_mvs.c文件的变量B0改成b0，xB0改成xb0，yB0改成yb0；</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">4.</span><br><span class=\"line\">libavcodec/opus_pvq.c: In function &apos;quant_band_template&apos;:</span><br><span class=\"line\">libavcodec/opus_pvq.c:498:9: error: expected identifier or &apos;(&apos; before numeric constant</span><br><span class=\"line\">     int B0 = blocks;</span><br><span class=\"line\">         ^</span><br><span class=\"line\">compilation terminated due to -Wfatal-errors.</span><br><span class=\"line\">make: *** [libavcodec/opus_pvq.o] Error 1</span><br></pre></td></tr></table></figure>\n<p>原因和解决办法：变量名冲突了，将FFmpeg/libavcodec/opus_pvq.c文件的变量B0改成b0；</p>\n","next":{"title":"Algorithm-Problem-重复的DNA序列","slug":"Algorithm-Problem-重复的DNA序列"},"link":"http://yoursite.com/post/NDK编译ffmpeg/"}