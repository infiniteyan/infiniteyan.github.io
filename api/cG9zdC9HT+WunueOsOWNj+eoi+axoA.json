{"title":"GO实现协程池","date":"2019-04-05T11:53:01.000Z","slug":"GO实现协程池","comments":true,"updated":"2019-04-05T11:56:26.156Z","content":"<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"runtime\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"strconv\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"sync\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type Runnable interface &#123;</span><br><span class=\"line\">\tRun()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type Task <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">\tname <span class=\"built_in\">string</span></span><br><span class=\"line\">\t<span class=\"function\">fun <span class=\"title\">func</span><span class=\"params\">(<span class=\"built_in\">string</span>)</span></span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (task *Task) Run() &#123;</span><br><span class=\"line\">\ttask.fun(task.name)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type Worker <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">\tid <span class=\"built_in\">string</span></span><br><span class=\"line\">\ttaskQueue chan Runnable</span><br><span class=\"line\">\twg *sync.WaitGroup</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (w *Worker) Start() &#123;</span><br><span class=\"line\">\t<span class=\"function\">go <span class=\"title\">func</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> wJob, ok:= &lt;- w.taskQueue : &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ok &#123;</span><br><span class=\"line\">\t\t\t\t\twJob.Run()</span><br><span class=\"line\">\t\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\tw.wg.Done()</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (w *Worker) Stop() &#123;</span><br><span class=\"line\">\tclose(w.taskQueue)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type WorkerPool struct &#123;</span><br><span class=\"line\">\tworkersSize <span class=\"keyword\">int</span></span><br><span class=\"line\">\tworkers []*Worker</span><br><span class=\"line\">\tjobQueue chan Runnable</span><br><span class=\"line\">\tworkerDispatcher chan *Worker</span><br><span class=\"line\">\twg sync.WaitGroup</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (pool *WorkerPool) newWorker(workerId <span class=\"built_in\">string</span>, taskSize <span class=\"keyword\">int</span>) *Worker &#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"New Worker : %s\\n\"</span>, workerId)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;Worker&#123;</span><br><span class=\"line\">\t\tid: workerId,</span><br><span class=\"line\">\t\ttaskQueue: make(chan Runnable, taskSize),</span><br><span class=\"line\">\t\twg: &amp;pool.wg,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (pool *WorkerPool) Init(workerTaskSize <span class=\"keyword\">int</span>) &#123;</span><br><span class=\"line\">\truntime.GOMAXPROCS(<span class=\"number\">3</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; pool.workersSize; i++ &#123;</span><br><span class=\"line\">\t\tworker := pool.newWorker(fmt.Sprintf(<span class=\"string\">\"worker-%s\"</span>, strconv.Itoa(i)), workerTaskSize)</span><br><span class=\"line\">\t\tpool.workers = append(pool.workers, worker)</span><br><span class=\"line\">\t\tpool.workerDispatcher &lt;- worker</span><br><span class=\"line\">\t\tworker.Start()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpool.wg.Add(pool.workersSize)</span><br><span class=\"line\">\tgo pool.start()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func NewPool(maxWorkers <span class=\"keyword\">int</span>, workerTaskSize <span class=\"keyword\">int</span>, maxQueue <span class=\"keyword\">int</span>) *WorkerPool &#123;</span><br><span class=\"line\">\tpool := WorkerPool&#123;</span><br><span class=\"line\">\t\tworkersSize: maxWorkers,</span><br><span class=\"line\">\t\tjobQueue: make(chan Runnable, maxQueue),</span><br><span class=\"line\">\t\tworkerDispatcher: make(chan *Worker, maxWorkers),</span><br><span class=\"line\">\t\twg: sync.WaitGroup&#123;&#125;,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpool.Init(workerTaskSize)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;pool</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (pool *WorkerPool) start() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> wJob, ok := &lt;-pool.jobQueue : &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ok &#123;</span><br><span class=\"line\">\t\t\t\tworker := &lt;- pool.workerDispatcher</span><br><span class=\"line\">\t\t\t\tworker.taskQueue &lt;- wJob</span><br><span class=\"line\">\t\t\t\tpool.workerDispatcher &lt;- worker</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">for</span> _, worker := range pool.workers &#123;</span><br><span class=\"line\">\t\t\t\t\tworker.Stop()</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (pool *WorkerPool) addTask(job Runnable) &#123;</span><br><span class=\"line\">\tpool.jobQueue &lt;- job</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (pool *WorkerPool) shutdown() &#123;</span><br><span class=\"line\">\tclose(pool.jobQueue)</span><br><span class=\"line\">\tpool.wg.Wait()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main () &#123;</span><br><span class=\"line\">\tpool := NewPool(<span class=\"number\">2</span>, <span class=\"number\">10</span>, <span class=\"number\">100</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfuc := func(p <span class=\"built_in\">string</span>) &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">\"%s执行完成\\n\"</span>, p)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">50</span>; i++ &#123;</span><br><span class=\"line\">\t\ttask := Task&#123;fmt.Sprintf(<span class=\"string\">\"任务%d\"</span>, i + <span class=\"number\">1</span>), fuc&#125;</span><br><span class=\"line\">\t\tpool.addTask(&amp;task)</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">\"添加任务%d\\n\"</span>, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpool.shutdown()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>执行结果<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">New Worker : worker-0</span><br><span class=\"line\">New Worker : worker-1</span><br><span class=\"line\">添加任务0</span><br><span class=\"line\">添加任务1</span><br><span class=\"line\">添加任务2</span><br><span class=\"line\">添加任务3</span><br><span class=\"line\">添加任务4</span><br><span class=\"line\">添加任务5</span><br><span class=\"line\">添加任务6</span><br><span class=\"line\">添加任务7</span><br><span class=\"line\">添加任务8</span><br><span class=\"line\">添加任务9</span><br><span class=\"line\">添加任务10</span><br><span class=\"line\">添加任务11</span><br><span class=\"line\">添加任务12</span><br><span class=\"line\">添加任务13</span><br><span class=\"line\">添加任务14</span><br><span class=\"line\">添加任务15</span><br><span class=\"line\">添加任务16</span><br><span class=\"line\">添加任务17</span><br><span class=\"line\">添加任务18</span><br><span class=\"line\">添加任务19</span><br><span class=\"line\">添加任务20</span><br><span class=\"line\">添加任务21</span><br><span class=\"line\">添加任务22</span><br><span class=\"line\">添加任务23</span><br><span class=\"line\">添加任务24</span><br><span class=\"line\">添加任务25</span><br><span class=\"line\">添加任务26</span><br><span class=\"line\">添加任务27</span><br><span class=\"line\">添加任务28</span><br><span class=\"line\">添加任务29</span><br><span class=\"line\">添加任务30</span><br><span class=\"line\">添加任务31</span><br><span class=\"line\">添加任务32</span><br><span class=\"line\">添加任务33</span><br><span class=\"line\">添加任务34</span><br><span class=\"line\">添加任务35</span><br><span class=\"line\">添加任务36</span><br><span class=\"line\">添加任务37</span><br><span class=\"line\">添加任务38</span><br><span class=\"line\">任务2执行完成</span><br><span class=\"line\">任务4执行完成</span><br><span class=\"line\">任务6执行完成</span><br><span class=\"line\">任务8执行完成</span><br><span class=\"line\">任务10执行完成</span><br><span class=\"line\">任务12执行完成</span><br><span class=\"line\">任务14执行完成</span><br><span class=\"line\">任务16执行完成</span><br><span class=\"line\">任务18执行完成</span><br><span class=\"line\">任务20执行完成</span><br><span class=\"line\">任务22执行完成</span><br><span class=\"line\">添加任务39</span><br><span class=\"line\">添加任务40</span><br><span class=\"line\">添加任务41</span><br><span class=\"line\">添加任务42</span><br><span class=\"line\">添加任务43</span><br><span class=\"line\">添加任务44</span><br><span class=\"line\">添加任务45</span><br><span class=\"line\">添加任务46</span><br><span class=\"line\">添加任务47</span><br><span class=\"line\">添加任务48</span><br><span class=\"line\">添加任务49</span><br><span class=\"line\">任务1执行完成</span><br><span class=\"line\">任务3执行完成</span><br><span class=\"line\">任务5执行完成</span><br><span class=\"line\">任务7执行完成</span><br><span class=\"line\">任务9执行完成</span><br><span class=\"line\">任务11执行完成</span><br><span class=\"line\">任务13执行完成</span><br><span class=\"line\">任务15执行完成</span><br><span class=\"line\">任务17执行完成</span><br><span class=\"line\">任务19执行完成</span><br><span class=\"line\">任务21执行完成</span><br><span class=\"line\">任务23执行完成</span><br><span class=\"line\">任务25执行完成</span><br><span class=\"line\">任务27执行完成</span><br><span class=\"line\">任务29执行完成</span><br><span class=\"line\">任务31执行完成</span><br><span class=\"line\">任务33执行完成</span><br><span class=\"line\">任务35执行完成</span><br><span class=\"line\">任务37执行完成</span><br><span class=\"line\">任务39执行完成</span><br><span class=\"line\">任务41执行完成</span><br><span class=\"line\">任务43执行完成</span><br><span class=\"line\">任务45执行完成</span><br><span class=\"line\">任务24执行完成</span><br><span class=\"line\">任务26执行完成</span><br><span class=\"line\">任务28执行完成</span><br><span class=\"line\">任务30执行完成</span><br><span class=\"line\">任务32执行完成</span><br><span class=\"line\">任务34执行完成</span><br><span class=\"line\">任务36执行完成</span><br><span class=\"line\">任务38执行完成</span><br><span class=\"line\">任务40执行完成</span><br><span class=\"line\">任务42执行完成</span><br><span class=\"line\">任务44执行完成</span><br><span class=\"line\">任务46执行完成</span><br><span class=\"line\">任务48执行完成</span><br><span class=\"line\">任务50执行完成</span><br><span class=\"line\">任务47执行完成</span><br><span class=\"line\">任务49执行完成</span><br></pre></td></tr></table></figure></p>\n","prev":{"title":"GO语言RPC之gRPC","slug":"GO语言RPC之gRPC"},"next":{"title":"GO并发：WaitGroup","slug":"GO并发：WaitGroup"},"link":"http://yoursite.com/post/GO实现协程池/"}