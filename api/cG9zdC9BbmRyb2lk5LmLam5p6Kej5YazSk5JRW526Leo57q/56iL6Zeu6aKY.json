{"title":"Android之jni解决JNIEnv跨线程问题","date":"2020-05-06T06:28:18.000Z","slug":"Android之jni解决JNIEnv跨线程问题","comments":true,"updated":"2020-05-06T06:32:35.935Z","content":"<h4 id=\"1-问题\">1.问题<a href=\"post/Android之jni解决JNIEnv跨线程问题#1-问题\"></a></h4><p>JNIEnv是一个线程相关的变量;<br>JNIEnv对于每个thread而言是唯一的;<br>JNIEnv *env指针不可以为多个线程共用;</p>\n<h4 id=\"2-解决办法\">2.解决办法<a href=\"post/Android之jni解决JNIEnv跨线程问题#2-解决办法\"></a></h4><p>java虚拟机的JavaVM指针是整个jvm公用的，我们可以用JavaVM来得到当前线程的JNIEnv指针，可以使用javaAttachThread保证取得当前线程的Jni环境变量</p>\n<p>实现如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JavaVM *g_jvm = NULL;</span><br><span class=\"line\">jobject g_obj = NULL;</span><br><span class=\"line\"></span><br><span class=\"line\">//由java调用来建立JNI环境</span><br><span class=\"line\">JNIEXPORT void Java_****_setJNIEnv( JNIEnv* env, jobject obj)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    //保存全局JVM以便在子线程中使用</span><br><span class=\"line\">    env-&gt;GetJavaVM(&amp;g_jvm);</span><br><span class=\"line\">    //不能直接赋值(g_obj = obj)</span><br><span class=\"line\">    g_obj = env-&gt;NewGlobalRef(obj);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//线程里面</span><br><span class=\"line\">JNIEnv *env;</span><br><span class=\"line\">jclass cls;</span><br><span class=\"line\">jmethodID mid;</span><br><span class=\"line\"> </span><br><span class=\"line\">//Attach主线程</span><br><span class=\"line\">if(g_jvm-&gt;AttachCurrentThread(&amp;env, NULL) != JNI_OK)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    return NULL;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//找到对应的类</span><br><span class=\"line\">cls = env-&gt;GetObjectClass(g_obj);</span><br><span class=\"line\">if(cls == NULL)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    goto error;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//再获得类中的方法</span><br><span class=\"line\">mid = env-&gt;GetMethodID(cls, &quot;fromJNI&quot;, &quot;(I)V&quot;);</span><br><span class=\"line\">if (mid == NULL)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    goto error; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//最后调用java中的静态方法</span><br><span class=\"line\">env-&gt;CallVoidMethod(cls, mid ,(int)arg);</span><br><span class=\"line\"> </span><br><span class=\"line\">error:</span><br><span class=\"line\">    return NULL;</span><br></pre></td></tr></table></figure></p>\n","prev":{"title":"设计模式-观察者模式","slug":"设计模式-观察者模式"},"next":{"title":"NDK编译ffmpeg","slug":"NDK编译ffmpeg"},"link":"http://yoursite.com/post/Android之jni解决JNIEnv跨线程问题/"}