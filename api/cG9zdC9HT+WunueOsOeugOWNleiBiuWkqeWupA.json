{"title":"GO实现简单聊天室","date":"2019-04-12T13:19:17.000Z","slug":"GO实现简单聊天室","comments":true,"updated":"2019-04-12T13:23:44.232Z","content":"<h4 id=\"GO实现一个简单聊天室\">GO实现一个简单聊天室<a href=\"post/GO实现简单聊天室#GO实现一个简单聊天室\"></a></h4><p>服务端<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">\t&quot;fmt&quot;</span><br><span class=\"line\">\t&quot;net&quot;</span><br><span class=\"line\">\t&quot;os&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">const (</span><br><span class=\"line\">\tHOST = &quot;localhost&quot;</span><br><span class=\"line\">\tPORT = &quot;8000&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">var clients []net.Conn</span><br><span class=\"line\"></span><br><span class=\"line\">func broadcast(msg string, conn net.Conn) &#123;</span><br><span class=\"line\">\tfor _, con := range clients &#123;</span><br><span class=\"line\">\t\tif con.RemoteAddr() != conn.RemoteAddr() &#123;</span><br><span class=\"line\">\t\t\tcon.Write([]byte(msg))</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func disconnect(con net.Conn, name string, shouldBroadcast bool) &#123;</span><br><span class=\"line\">\tfor index, conn := range clients &#123;</span><br><span class=\"line\">\t\tif con.RemoteAddr() == conn.RemoteAddr() &#123;</span><br><span class=\"line\">\t\t\tmessage := name + &quot; has left the room.&quot;</span><br><span class=\"line\">\t\t\tfmt.Println(message)</span><br><span class=\"line\">\t\t\tclients = append(clients[:index], clients[index+1:]...)</span><br><span class=\"line\">\t\t\tif shouldBroadcast &#123;</span><br><span class=\"line\">\t\t\t\tbroadcast(message, con)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tfmt.Println(&quot;Initializing server...&quot;)</span><br><span class=\"line\">\tlisten, err := net.Listen(&quot;tcp&quot;, HOST+&quot;:&quot;+PORT)</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tfmt.Println(&quot;listen on port error :&quot;, err)</span><br><span class=\"line\">\t\tos.Exit(1)</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tdefer listen.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tconnIn, err := listen.Accept()</span><br><span class=\"line\">\t\tif err != nil &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(&quot;error acceptint client :&quot;, err.Error())</span><br><span class=\"line\">\t\t\tcontinue</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tclients = append(clients, connIn)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tgo func(conn net.Conn) &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(&quot;New Connection :&quot;, conn.RemoteAddr())</span><br><span class=\"line\">\t\t\tvar buffer = make([]byte, 2048)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tlength, err := conn.Read(buffer)</span><br><span class=\"line\">\t\t\tif err != nil &#123;</span><br><span class=\"line\">\t\t\t\tfmt.Printf(&quot;Client %v quit.\\n&quot;, conn.RemoteAddr())</span><br><span class=\"line\">\t\t\t\tconn.Close()</span><br><span class=\"line\">\t\t\t\tdisconnect(conn, conn.RemoteAddr().String(), false)</span><br><span class=\"line\">\t\t\t\treturn</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tname := string(buffer[:length])</span><br><span class=\"line\">\t\t\tcomeStr := name + &quot; enter the room.&quot;</span><br><span class=\"line\">\t\t\tbroadcast(comeStr, conn)</span><br><span class=\"line\">\t\t\tfor &#123;</span><br><span class=\"line\">\t\t\t\tlength, err := conn.Read(buffer)</span><br><span class=\"line\">\t\t\t\tif err != nil &#123;</span><br><span class=\"line\">\t\t\t\t\tfmt.Printf(&quot;Client %s quit.\\n&quot;, name)</span><br><span class=\"line\">\t\t\t\t\tconn.Close()</span><br><span class=\"line\">\t\t\t\t\tdisconnect(conn, name, true)</span><br><span class=\"line\">\t\t\t\t\treturn</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tres := string(buffer[:length])</span><br><span class=\"line\">\t\t\t\tsprdMsg := name + &quot; said: &quot; + res</span><br><span class=\"line\">\t\t\t\tfmt.Println(sprdMsg)</span><br><span class=\"line\">\t\t\t\treplyMsg := &quot;You said: &quot; + res</span><br><span class=\"line\">\t\t\t\tconn.Write([]byte(replyMsg))</span><br><span class=\"line\">\t\t\t\tbroadcast(sprdMsg, conn)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;(connIn)</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>客户端<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">\t&quot;bufio&quot;</span><br><span class=\"line\">\t&quot;fmt&quot;</span><br><span class=\"line\">\t&quot;net&quot;</span><br><span class=\"line\">\t&quot;os&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">var (</span><br><span class=\"line\">\twriteBuffer = make([]byte, 2048)</span><br><span class=\"line\">\treadBuffer  = make([]byte, 2048)</span><br><span class=\"line\">\treader      = bufio.NewReader(os.Stdin)</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">const (</span><br><span class=\"line\">\tHOST = &quot;localhost&quot;</span><br><span class=\"line\">\tPORT = &quot;8000&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\t//runtime.GOMAXPROCS(2)</span><br><span class=\"line\">\tconn, err := net.Dial(&quot;tcp&quot;, HOST+&quot;:&quot;+PORT)</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tfmt.Println(&quot;server not found.&quot;)</span><br><span class=\"line\">\t\tos.Exit(-1)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tdefer conn.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Println(&quot;Connection established.&quot;)</span><br><span class=\"line\">\tfmt.Printf(&quot;Enter your name:&quot;)</span><br><span class=\"line\">\tfmt.Scanf(&quot;%s&quot;, &amp;writeBuffer)</span><br><span class=\"line\">\tin, err := conn.Write([]byte(writeBuffer))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tfmt.Println(&quot;Error when send to server:%d.&quot;, in)</span><br><span class=\"line\">\t\tos.Exit(0)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tgo func(con net.Conn) &#123;</span><br><span class=\"line\">\t\tfor &#123;</span><br><span class=\"line\">\t\t\tlength, err := con.Read(readBuffer)</span><br><span class=\"line\">\t\t\tif err != nil &#123;</span><br><span class=\"line\">\t\t\t\tfmt.Printf(&quot;Error when read from server. error:%s\\n&quot;, err)</span><br><span class=\"line\">\t\t\t\tos.Exit(0)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tfmt.Println(string(readBuffer[:length]))</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;(conn)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\twriteBuffer, _, _ = reader.ReadLine()</span><br><span class=\"line\">\t\tif string(writeBuffer) == &quot;quit&quot; &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(&quot;Communication terminated.&quot;)</span><br><span class=\"line\">\t\t\tos.Exit(1)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tin, err := conn.Write([]byte(writeBuffer))</span><br><span class=\"line\">\t\tif err != nil &#123;</span><br><span class=\"line\">\t\t\tfmt.Printf(&quot;Send to server error:%d\\n&quot;, in)</span><br><span class=\"line\">\t\t\tos.Exit(0)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>运行结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./server</span><br><span class=\"line\">Initializing server...</span><br><span class=\"line\">New Connection : 127.0.0.1:64946</span><br><span class=\"line\">Tom said: hello</span><br><span class=\"line\">New Connection : 127.0.0.1:64952</span><br><span class=\"line\">Jerry said: hiahia</span><br><span class=\"line\">Jerry said: 你好啊</span><br><span class=\"line\">Tom said: 你是谁？</span><br><span class=\"line\">Jerry said: 随便进来看看</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./client</span><br><span class=\"line\">Connection established.</span><br><span class=\"line\">Enter your name:Tom  </span><br><span class=\"line\">hello</span><br><span class=\"line\">You said: hello</span><br><span class=\"line\">Jerry enter the room.</span><br><span class=\"line\">Jerry said: hiahia</span><br><span class=\"line\">Jerry said: 你好啊</span><br><span class=\"line\">你是谁？</span><br><span class=\"line\">You said: 你是谁？</span><br><span class=\"line\">Jerry said: 随便进来看看</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./client</span><br><span class=\"line\">Connection established.</span><br><span class=\"line\">Enter your name:Jerry</span><br><span class=\"line\">hiahia</span><br><span class=\"line\">You said: hiahia</span><br><span class=\"line\">你好啊</span><br><span class=\"line\">You said: 你好啊</span><br><span class=\"line\">Tom said: 你是谁？</span><br><span class=\"line\">随便进来看看</span><br><span class=\"line\">You said: 随便进来看看</span><br></pre></td></tr></table></figure>","prev":{"title":"GO语言操作RabbitMQ","slug":"GO语言操作RabbitMQ"},"next":{"title":"GO语言RPC之gRPC","slug":"GO语言RPC之gRPC"},"link":"http://yoursite.com/post/GO实现简单聊天室/"}